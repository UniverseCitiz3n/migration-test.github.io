<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.21.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>The power of Three! Intune + Powershell + MicrosoftGraph - Maciej Horbacz</title>
<meta name="description" content="Easy way to break and fix things in a matter of seconds! ‚ö†Ô∏è">


  <meta name="author" content="Hi">
  


<meta property="og:type" content="website">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Maciej Horbacz">
<meta property="og:title" content="The power of Three! Intune + Powershell + MicrosoftGraph">
<meta property="og:url" content="http://localhost:4000/_posts/2020-01-31-Intune-BulkActions/">


  <meta property="og:description" content="Easy way to break and fix things in a matter of seconds! ‚ö†Ô∏è">



  <meta property="og:image" content="http://localhost:4000/assets/head_image_big.png">



  <meta name="twitter:site" content="@UniverseCitiz3n">
  <meta name="twitter:title" content="The power of Three! Intune + Powershell + MicrosoftGraph">
  <meta name="twitter:description" content="Easy way to break and fix things in a matter of seconds! ‚ö†Ô∏è">
  <meta name="twitter:url" content="http://localhost:4000/_posts/2020-01-31-Intune-BulkActions/">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="http://localhost:4000/assets/head_image_big.png">
    
  

  







  

  


<link rel="canonical" href="http://localhost:4000/_posts/2020-01-31-Intune-BulkActions/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Maciej Horbacz",
      "url": "http://localhost:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Maciej Horbacz Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



<!-- Twitter cards -->
<meta name="twitter:site"    content="@">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="The power of Three! Intune + Powershell + MicrosoftGraph">


<meta name="twitter:description" content="My ideas and solutions to sysadmin problems">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="/assets/head_image_big.png">

<!-- end of Twitter cards -->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--page">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
          Maciej Horbacz
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">Home</a>
            </li><li class="masthead__menu-item">
              <a href="/autopilot/">Autopilot</a>
            </li><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li><li class="masthead__menu-item">
              <a href="/events/">Events</a>
            </li><li class="masthead__menu-item">
              <a href="https://leanpub.com/psconfbook3/">Publications</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/terms/">Terms & Conditions</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      <h1 id="intro">Intro</h1>

<p>Today I‚Äôd like to show you how I‚Äôve was able to force reboot 197 devices to fix Windows Updates issue with just a few lines of code<br /></p>

<p><img src="http://localhost:4000/assets/images/posts/2020-01-31.gif" alt="image0" /></p>

<h1 id="the-issue">The issue</h1>

<p>Some users don‚Äôt have a habit to restart device from time to time‚Ä¶ In our environment that behavior led to problem with installing Quality updates on endpoints. December 2019 Feature update requires <strong>one reboot</strong> after downloading to start installing. Without that <strong>one reboot</strong> Quality updates just stacked and it all lead to major security risks! Yes, Intune allows you to set <strong>Deadline for updates</strong> but it is connected with applying update process.</p>

<p><img src="http://localhost:4000/assets/images/posts/2020-01-31_2.jpg" alt="image2" /></p>

<p>To check how big this issue could be you can go to <a href="https://devicemanagement.microsoft.com/#blade/Microsoft_Intune_DeviceSettings/DevicesMenu/windows10UpdateRings">Windows 10 update rings</a> and then select desired update ring. Your eyes probably see something like:</p>

<p><img src="http://localhost:4000/assets/images/posts/2020-01-31_1.jpg" alt="image1" /></p>

<p><strong>‚ùó‚ùó Look carefully because this view only shows update profile assignment status ‚ùó‚ùó</strong> not real status of updates per device. To see that you need to click on <strong>End user update status</strong>üïµüèº</p>

<p><img src="http://localhost:4000/assets/images/posts/2020-01-31_3.jpg" alt="image3" /></p>

<p>There you can see detailed status for each device. And the options are:<br /></p>

<table>
  <tbody>
    <tr>
      <td>Status</td>
      <td>Value</td>
      <td>Description</td>
    </tr>
    <tr>
      <td>upToDate</td>
      <td>0</td>
      <td>There are no pending updates, no pending reboot updates and no failed updates.</td>
    </tr>
    <tr>
      <td>pendingInstallation</td>
      <td>1</td>
      <td>There are updates that‚Äôs pending installation which includes updates that are not approved. There are no Pending reboot updates, no failed updates.</td>
    </tr>
    <tr>
      <td>pendingReboot</td>
      <td>2</td>
      <td>There are updates that requires reboot. There are not failed updates.</td>
    </tr>
    <tr>
      <td>failed</td>
      <td>3</td>
      <td>There are updates failed to install on the device.</td>
    </tr>
  </tbody>
</table>

<h1 id="time-to-fix-it-">Time to fix it! üî±</h1>

<p>Solution for described scenario is plain simple reboot which should allow Windows Update service to push installation forward. You can nicely <strong>ask</strong> user to perform reboot but it might have effectiveness around a few or a dozen percentage. To fix it immediately you will need:</p>

<ul>
  <li><a href="https://www.powershellgallery.com/packages/Microsoft.Graph.Intune/6.1907.1.0">PowerShell SDK for Microsoft Intune Graph API</a></li>
  <li>Account with Global Administrator Rights or proper configuration of Powershell MSGraph in your tenant</li>
  <li>Powershell console</li>
</ul>

<p>After you install Microsoft Graph module you need to connect to service and from there you will be able to grab list of devices with their update statuses and perform reboot. I recommend to get familiar with documentation <a href="https://docs.microsoft.com/en-us/graph/api/resources/intune-devices-manageddevice?view=graph-rest-beta">here</a> and Graph Explorer <a href="https://developer.microsoft.com/en-us/graph/graph-explorer">here</a> it will come in handy in your journey with MicrosoftGraph üåå.</p>

<p>Time to make some mess!</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="c">#Connecting to GraphAPI</span><span class="w">
</span><span class="n">Connect-MSGraph</span><span class="w">

</span><span class="c">#Get list of Windows devices</span><span class="w">
</span><span class="nv">$MSGraphComputers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Get-DeviceManagement_ManagedDevices</span><span class="p">)</span><span class="o">.</span><span class="nf">value</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">$PSItem</span><span class="o">.</span><span class="nf">operatingSystem</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'Windows'</span><span class="p">}</span><span class="w">

</span><span class="c">#Get list of Windows10 Update rings</span><span class="w">
</span><span class="nv">$WindowsUpdateRings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-DeviceManagement_DeviceConfigurations</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">$PSItem</span><span class="o">.</span><span class="s1">'@odata.type'</span><span class="w"> </span><span class="o">-like</span><span class="w"> </span><span class="s1">'*windowsupdate*'</span><span class="w"> </span><span class="p">}</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">ogv</span><span class="w"> </span><span class="nt">-PassThru</span><span class="w">

</span><span class="c">#Get list of update states</span><span class="w">
</span><span class="nv">$DeviceUpdateStates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">foreach</span><span class="p">(</span><span class="nv">$Ring</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$WindowsUpdateRings</span><span class="p">){</span><span class="w">
    </span><span class="p">(</span><span class="n">Invoke-MSGraphRequest</span><span class="w"> </span><span class="nt">-HttpMethod</span><span class="w"> </span><span class="nx">GET</span><span class="w"> </span><span class="nt">-Url</span><span class="w"> </span><span class="s2">"https://graph.microsoft.com/beta/deviceManagement/deviceConfigurations/</span><span class="si">$(</span><span class="nv">$Ring</span><span class="o">.</span><span class="nf">id</span><span class="si">)</span><span class="s2">/microsoft.graph.windowsUpdateForBusinessConfiguration/deviceUpdateStates"</span><span class="p">)</span><span class="o">.</span><span class="nf">Value</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c">#Force reboot devices</span><span class="w">
</span><span class="nv">$DeviceUpdateStates</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">$PSItem</span><span class="o">.</span><span class="s1">'Update Status'</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'Failed'</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Invoke-DeviceManagement_ManagedDevices_RebootNow</span><span class="w">

</span></code></pre></div></div>

<p>Device will be restarted within 10 minutes with first notification:</p>

<p><img src="http://localhost:4000/assets/images/posts/2020-01-31_4.jpg" alt="image4" /></p>

<p>and 2 minutes before:</p>

<p><img src="http://localhost:4000/assets/images/posts/2020-01-31_5.jpg" alt="image5" /></p>

<p>Yeah it is in language set in Windows</p>

<h1 id="summary">Summary</h1>

<p>Even though Intune itself does not allow to perform bulk actions it can be easily done with a little bit of Powershell magic‚ú®</p>

<p>See you in next! üòâ üß†</p>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/UniverseCitiz3n" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
      
        
          <li><a href="https://github.com/UniverseCitiz3n" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 Maciej Horbacz. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    
  <script>
    var disqus_config = function () {
      this.page.url = "http://localhost:4000/_posts/2020-01-31-Intune-BulkActions/";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = ""; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://uc3n.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  





  </body>
</html>
